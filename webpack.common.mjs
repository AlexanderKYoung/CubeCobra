import path from 'path';
import url from 'url';
import { merge } from 'webpack-merge';
import nodeExternals from 'webpack-node-externals';

// eslint-disable-next-line no-underscore-dangle
const __dirname = url.fileURLToPath(new URL('.', import.meta.url));

const config = {
  module: {
    rules: [
      {
        test: /\.jsx?$/,
        exclude: /node_modules[/\\](?!react-dnd|dnd-core)/,
        use: {
          loader: 'babel-loader',
          options: {
            configFile: path.resolve(__dirname, 'babel.config.mjs'),
          },
        },
      },
      {
        test: /\.tsx?$/,
        exclude: /node_modules/,
        use: {
          loader: 'ts-loader',
        },
      },
      {
        test: /\.(css|less)$/,
        use: ['style-loader', 'css-loader'],
      },
      {
        test: /\.b64$/,
        use: 'raw-loader',
      },
      {
        test: /\.m?js/,
        resolve: {
          fullySpecified: false,
        },
      },
    ],
  },
  devtool: 'source-map',
  resolve: {
    extensions: ['.js', '.ts', '.jsx', '.tsx', '.json'],
    modules: [path.resolve(__dirname, 'src'), 'node_modules'],
  },
};

export const clientConfig = merge(config, {
  entry: {
    BlogPostPage: './src/pages/BlogPostPage.tsx',
    BulkUploadPage: './src/pages/BulkUploadPage.js',
    CubeSamplePackPage: './src/pages/CubeSamplePackPage.js',
    CubeAnalysisPage: './src/pages/CubeAnalysisPage.tsx',
    CubeBlogPage: './src/pages/CubeBlogPage.js',
    CubeComparePage: './src/pages/CubeComparePage.tsx',
    CubeDeckPage: './src/pages/CubeDeckPage.js',
    CubeDecksPage: './src/pages/CubeDecksPage.js',
    CubeDeckbuilderPage: './src/pages/CubeDeckbuilderPage.js',
    CubeDraftPage: './src/pages/CubeDraftPage.js',
    CubeListPage: './src/pages/CubeListPage.js',
    CubeHistoryPage: './src/pages/CubeHistoryPage.js',
    CubeOverviewPage: './src/pages/CubeOverviewPage.js',
    CubePlaytestPage: './src/pages/CubePlaytestPage.js',
    DashboardPage: './src/pages/DashboardPage.js',
    GridDraftPage: './src/pages/GridDraftPage.js',
    DevBlog: './src/pages/DevBlog.js',
    ContactPage: './src/pages/ContactPage.tsx',
    DonatePage: './src/pages/DonatePage.js',
    InfoPage: './src/pages/InfoPage.js',
    FiltersPage: './src/pages/FiltersPage.js',
    DownTimePage: './src/pages/DownTimePage.js',
    ErrorPage: './src/pages/ErrorPage.js',
    CardSearchPage: './src/pages/CardSearchPage.tsx',
    TopCardsPage: './src/pages/TopCardsPage.tsx',
    CardPage: './src/pages/CardPage.tsx',
    CommentPage: './src/pages/CommentPage.tsx',
    LoginPage: './src/pages/LoginPage.js',
    RegisterPage: './src/pages/RegisterPage.js',
    LostPasswordPage: './src/pages/LostPasswordPage.js',
    NotificationsPage: './src/pages/NotificationsPage.js',
    PasswordResetPage: './src/pages/PasswordResetPage.js',
    UserAccountPage: './src/pages/UserAccountPage.js',
    UserBlogPage: './src/pages/UserBlogPage.js',
    UserDecksPage: './src/pages/UserDecksPage.js',
    UserSocialPage: './src/pages/UserSocialPage.js',
    UserCubePage: './src/pages/UserCubePage.js',
    ExplorePage: './src/pages/ExplorePage.js',
    SearchPage: './src/pages/SearchPage.js',
    RecentDraftsPage: './src/pages/RecentDraftsPage.js',
    VersionPage: './src/pages/VersionPage.js',
    LandingPage: './src/pages/LandingPage.tsx',
    AdminDashboardPage: './src/pages/AdminDashboardPage.tsx',
    NoticePage: './src/pages/NoticePage.tsx',
    ApplicationPage: './src/pages/ApplicationPage.tsx',
    CreatorsPage: './src/pages/CreatorsPage.tsx',
    MarkdownPage: './src/pages/MarkdownPage.js',
    EditArticlePage: './src/pages/EditArticlePage.js',
    ArticlePage: './src/pages/ArticlePage.tsx',
    ReviewContentPage: './src/pages/ReviewContentPage.tsx',
    ArticlesPage: './src/pages/ArticlesPage.tsx',
    EditVideoPage: './src/pages/EditVideoPage.js',
    VideoPage: './src/pages/VideoPage.tsx',
    VideosPage: './src/pages/VideosPage.js',
    EditPodcastPage: './src/pages/EditPodcastPage.js',
    PodcastPage: './src/pages/PodcastPage.tsx',
    PodcastsPage: './src/pages/PodcastsPage.js',
    PodcastEpisodePage: './src/pages/PodcastEpisodePage.js',
    BrowseContentPage: './src/pages/BrowseContentPage.tsx',
    LeaveWarningPage: './src/pages/LeaveWarningPage.tsx',
    PackagePage: './src/pages/PackagePage.js',
    FeaturedCubesQueuePage: './src/pages/FeaturedCubesQueuePage.js',
    PackagesPage: './src/pages/PackagesPage.tsx',
  },
  output: {
    filename: '[name].bundle.js',
    sourceMapFilename: '[name].js.map',
    path: path.resolve(__dirname, 'dist'),
  },
  externals: {
    react: 'React',
    'react-dom': 'ReactDOM',
  },
});

export const serverConfig = merge(config, {
  target: 'node',
  entry: {
    'pages/DashboardPage': './src/pages/DashboardPage.js',
    'pages/DevBlog': './src/pages/DevBlog.js',
    'pages/Loading': './src/pages/Loading.js',
    'pages/BlogPostPage': './src/pages/BlogPostPage.tsx',
    'pages/BulkUploadPage': './src/pages/BulkUploadPage.js',
    'pages/CubeAnalysisPage': './src/pages/CubeAnalysisPage.tsx',
    'pages/CubeBlogPage': './src/pages/CubeBlogPage.js',
    'pages/CubeComparePage': './src/pages/CubeComparePage.tsx',
    'pages/CubeDeckPage': './src/pages/CubeDeckPage.js',
    'pages/CubeDeckbuilderPage': './src/pages/CubeDeckbuilderPage.js',
    'pages/CubeDecksPage': './src/pages/CubeDecksPage.js',
    'pages/CubeDraftPage': './src/pages/CubeDraftPage.js',
    'pages/CubeListPage': './src/pages/CubeListPage.js',
    'pages/CubeHistoryPage': './src/pages/CubeHistoryPage.js',
    'pages/CubeOverviewPage': './src/pages/CubeOverviewPage.js',
    'pages/CubePlaytestPage': './src/pages/CubePlaytestPage.js',
    'pages/CubeSamplePackPage': './src/pages/CubeSamplePackPage.js',
    'pages/GridDraftPage': './src/pages/GridDraftPage.js',
    'pages/ContactPage': './src/pages/ContactPage.tsx',
    'pages/InfoPage': './src/pages/InfoPage.js',
    'pages/DonatePage': './src/pages/DonatePage.js',
    'pages/DownTimePage': './src/pages/DownTimePage.js',
    'pages/FiltersPage': './src/pages/FiltersPage.js',
    'pages/ErrorPage': './src/pages/ErrorPage.js',
    'pages/CardSearchPage': './src/pages/CardSearchPage.tsx',
    'pages/TopCardsPage': './src/pages/TopCardsPage.tsx',
    'pages/CardPage': './src/pages/CardPage.tsx',
    'pages/CommentPage': './src/pages/CommentPage.tsx',
    'pages/LoginPage': './src/pages/LoginPage.js',
    'pages/RegisterPage': './src/pages/RegisterPage.js',
    'pages/LostPasswordPage': './src/pages/LostPasswordPage.js',
    'pages/NotificationsPage': './src/pages/NotificationsPage.js',
    'pages/PasswordResetPage': './src/pages/PasswordResetPage.js',
    'pages/UserAccountPage': './src/pages/UserAccountPage.js',
    'pages/UserBlogPage': './src/pages/UserBlogPage.js',
    'pages/UserDecksPage': './src/pages/UserDecksPage.js',
    'pages/UserSocialPage': './src/pages/UserSocialPage.js',
    'pages/UserCubePage': './src/pages/UserCubePage.js',
    'pages/ExplorePage': './src/pages/ExplorePage.js',
    'pages/SearchPage': './src/pages/SearchPage.js',
    'pages/RecentDraftsPage': './src/pages/RecentDraftsPage.js',
    'pages/VersionPage': './src/pages/VersionPage.js',
    'pages/LandingPage': './src/pages/LandingPage.tsx',
    'pages/AdminDashboardPage': './src/pages/AdminDashboardPage.tsx',
    'pages/NoticePage': './src/pages/NoticePage.tsx',
    'pages/ApplicationPage': './src/pages/ApplicationPage.tsx',
    'pages/CreatorsPage': './src/pages/CreatorsPage.tsx',
    'pages/MarkdownPage': './src/pages/MarkdownPage.js',
    'pages/ArticlePage': './src/pages/ArticlePage.tsx',
    'pages/EditArticlePage': './src/pages/EditArticlePage.js',
    'pages/ReviewContentPage': './src/pages/ReviewContentPage.tsx',
    'pages/ArticlesPage': './src/pages/ArticlesPage.tsx',
    'pages/VideoPage': './src/pages/VideoPage.tsx',
    'pages/EditVideoPage': './src/pages/EditVideoPage.js',
    'pages/VideosPage': './src/pages/VideosPage.js',
    'pages/PodcastPage': './src/pages/PodcastPage.tsx',
    'pages/EditPodcastPage': './src/pages/EditPodcastPage.js',
    'pages/PodcastsPage': './src/pages/PodcastsPage.js',
    'pages/PodcastEpisodePage': './src/pages/PodcastEpisodePage.js',
    'pages/BrowseContentPage': './src/pages/BrowseContentPage.tsx',
    'pages/LeaveWarningPage': './src/pages/LeaveWarningPage.tsx',
    'pages/PackagePage': './src/pages/PackagePage.js',
    'pages/FeaturedCubesQueuePage': './src/pages/FeaturedCubesQueuePage.js',
    'pages/PackagesPage': './src/pages/PackagesPage.tsx',
    'drafting/createdraft': './src/drafting/createdraft.ts',
    'drafting/draftutil': './src/drafting/draftutil.js',
    'filtering/FilterCards': './src/filtering/FilterCards.ts',
    'utils/Card': './src/utils/Card.ts',
    'utils/Sort': './src/utils/Sort.ts',
    'utils/Util': './src/utils/Util.ts',
    'markdown/parser': './src/markdown/parser.js',
  },
  output: {
    filename: '[name].js',
    sourceMapFilename: '[name].js.map',
    path: path.resolve(__dirname, 'dist'),
    libraryTarget: 'commonjs2',
  },
  externals: [
    nodeExternals({
      allowlist: [],
    }),
  ],
});
